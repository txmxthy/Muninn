import time

import fontawesome as fa

from common.deps.pymetasploit3 import msfrpc
from common.deps.pymetasploit3.msfrpc import MsfError, PayloadModule, ExploitModule
from common.util import run_module_with_output


def Exploit(app, selection, host):
    cid = app.rpc["Client"].consoles.console().cid
    console = app.rpc["Client"].consoles.console(cid)

    print(fa.icons["arrow-right"] + " " + selection['name'], selection['fullname'], selection['rank'],
          selection['disclosuredate'])

    fullname = selection['fullname'].split("/")
    kind = fullname[0]
    expl = "/".join(fullname[1:])
    exploit: ExploitModule = app.rpc["Client"].modules.use(kind, expl)
    exploit.check()
    print(fa.icons["spinner"] + " Running " + kind + expl)
    Execute(app, exploit, target=host)


def Execute(app, exploit, target):


    runoptions = {}
    if 'RHOSTS' in exploit.missing_required:
        runoptions['RHOSTS'] = target['address']
        print(runoptions['RHOSTS'])

    console = app.rpc["Client"].consoles.console()
    cid = console.cid
    time.sleep(1)

    out = run_module_with_output(console, exploit, runoptions=runoptions)
    print(out)  # print output

    while len(app.rpc["Client"].sessions.list) == 0:
        console.write("sessions -l")
        print(console.read())
        time.sleep(1)


